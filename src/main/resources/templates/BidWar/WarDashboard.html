<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Item Details | BidIT</title>

    <!-- Fragment & Page CSS -->
    <link rel="stylesheet" th:href="@{/Styles/fragmentCSS.css}">
    <link rel="stylesheet" th:href="@{/Styles/WarDashCSS.css}">
</head>
<body>

<div th:replace="Fragments  :: sidebar(${users})"></div>
<div th:replace="Fragments  :: navbar"></div>

<div class="main-content">

    <!-- ================= ITEM DETAILS ================= -->
    <div class="item-details-card">

        <div class="item-image">
            <img th:src="@{/items/{img}(img=${item.itemImage})}" alt="Item Image">
        </div>

        <div class="item-info">
            <h2 th:text="${item.ItemName}">Item Name</h2>

            <p class="description" th:text="${item.description}">
                Item description
            </p>

            <div class="info-grid">
                <span><strong>Status:</strong> <span th:text="${item.status}"></span></span>
                <span><strong>Category:</strong> <span th:text="${item.category.name}"></span></span>
                <span><strong>Rate:</strong> <span th:text="${item.rate}"></span></span>
                <span><strong>Base Amount:</strong> Rs. <span th:text="${item.amount}"></span></span>
                <span><strong>Placed By:</strong><span th:text="${item.user != null ? item.user.username : (item.admin != null ? item.admin.username : 'N/A')}"></span></span>
            </div>

            <!-- TIMER -->
            <div class="auction-timer">
                ‚è≥ Total Auction Time Left: <span id="timer">00:00</span>
            </div>

        </div>
    </div>

    <!-- ================= BID WAR ================= -->
    <div class="bid-war">

        <h3>üî• Bid War</h3>


        <!-- Bid List -->
        <div class="bid-list">
            <div class="bid-card" th:each="bid : ${bids}">
                <span class="bidder" th:text="${bid.user.username}">User</span>
                <span class="amount">Rs. <span th:text="${bid.bidAmount}"></span></span>
                <span class="time"
                      th:text="${#temporals.format(bid.bidTime,'HH:mm:ss')}">
                </span>
            </div>
        </div>
        <div class="bid-action">
            <button class="bid-btn"
                    th:disabled="${auctionEnded or !canBid}"
                    onclick="openBidForm()">
                üöÄ Bid Now
            </button>

            <p class="error-message" th:if="${!canBid}">
                ‚ùå Not enough budget to place a higher bid
            </p>

            <p th:if="${auctionEnded}" class="error-message">
                ‚è∞ Auction has ended
            </p>
        </div>
    </div>
</div>

<!-- ================= BID MODAL ================= -->
<div id="bidModal" class="bid-modal">

    <div class="bid-modal-content">

        <span class="close" onclick="closeBidForm()">&times;</span>

        <h3>Place Your Bid</h3>

        <form th:action="@{/auction/bidwar/place}" method="post">

            <!-- Item ID -->
            <input type="hidden" name="itemId" th:value="${item.itemId}">

            <!-- Bidder -->
            <label>Bidder</label>
            <input type="text"
                   th:value="${users.username}"
                   readonly>

            <!-- Base Amount -->
            <label>Base Amount</label>
            <input type="text"
                   th:value="${item.amount}"
                   readonly>

            <!-- Highest Bid -->
            <label>Current Highest Bid</label>
            <input type="text"
                   th:value="${highestBidAmount}"
                   readonly>

            <label>Your Available Budget</label>
            <input type="text" th:value="${budget.total}" readonly>


            <!-- Bid Amount -->
            <label>Your Bid Amount</label>
            <input type="number"
                   name="bidAmount"
                   step="0.01"
                   th:attr="min=${minBid}, max=${maxBid}"
                   th:disabled="${!canBid}"

                   placeholder="Enter bid amount"
                   required>

            <div class="error-message" th:if="${bidError}" th:text="${bidError}"></div>

            <button type="submit">Confirm Bid</button>

        </form>

    </div>
</div>
<div th:if="${auctionEnded and item.bidDetails != null}">
    <h2 style="color:green">
        üéâ Congratulations
        <span th:text="${item.bidDetails.buyer.username}"></span>
    </h2>

    <p>
        Winning Bid: Rs.
        <span th:text="${item.bidDetails.amount}"></span>
    </p>
</div>
<!-- ================= JS ================= -->
<script th:inline="javascript">

    function openBidForm() {
       document.getElementById("bidModal").style.display = "block";
   }

   function closeBidForm() {
       document.getElementById("bidModal").style.display = "none";
   }
   let remainingSeconds = [[${remainingSeconds}]];

   function startAuctionTimer() {
       const timer = document.getElementById("timer");

       const interval = setInterval(() => {

           if (remainingSeconds <= 0) {
               clearInterval(interval);
               timer.innerText = "00:00";
               location.reload(); // reload to show winner
               return;
           }

           const minutes = Math.floor(remainingSeconds / 60);
           const seconds = remainingSeconds % 60;

           timer.innerText =
               minutes.toString().padStart(2,'0') + ":" +
               seconds.toString().padStart(2,'0');

           remainingSeconds--;
       }, 1000);
   }

   window.onload = startAuctionTimer;
</script>

</body>
</html>
